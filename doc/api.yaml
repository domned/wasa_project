---
openapi: 3.0.3
info:
    title: 'WASAText API'
    description: |-
        A modern chat application API that allows users to create groups,
        start conversations, send messages, react to messages, and manage
        contacts.

        Features include:
        - Real-time messaging with WebSocket support
        - Image messaging with automatic compression
        - Message reactions with toggle behavior (prevents duplicates)
        - Group chat management
        - Contact management
        - Message forwarding (including images)
        - User profiles with photos
    version: '1.2.0'

security:
    - bearerAuth: []

components:
    securitySchemes:
        bearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT

    schemas:
        User:
            type: object
            properties:
                id:
                    type: string
                    example: 'f2555a8a-2e66-4326-9588-20e7e298d615'
                    description: UUID of the user
                username:
                    type: string
                    example: 'Alice'
                    pattern: '^.*?$'
                    minLength: 3
                    maxLength: 16
                picture:
                    type: string
                    example: 'https://example.com/avatar.jpg'
                    description: URL to user's profile picture
            required:
                - id
                - username

        Conversation:
            type: object
            properties:
                id:
                    type: string
                    example: 'c0c0c0c0-0000-0000-0000-000000000001'
                    description: UUID of the conversation
                name:
                    type: string
                    example: 'Group Chat'
                    description: Name of the conversation (empty for 1:1 chats)
                picture:
                    type: string
                    example: 'https://example.com/group-avatar.jpg'
                    description: URL to conversation's picture
                participants:
                    type: array
                    items:
                        $ref: '#/components/schemas/User'
                    description: List of users in the conversation
            required:
                - id
                - participants

        Message:
            type: object
            properties:
                id:
                    type: string
                    example: '85f9cc23-48d7-448d-9172-7d5fd9cd4858'
                    description: UUID of the message
                senderId:
                    type: string
                    example: 'f2555a8a-2e66-4326-9588-20e7e298d615'
                    description: UUID of the message sender
                text:
                    type: string
                    example: 'Hello, how are you?'
                    description: Content of the message
                imageUrl:
                    type: string
                    example: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...'
                    description: Base64 encoded image data with MIME type prefix (optional)
                senderUsername:
                    type: string
                    example: 'Alice'
                    description: Username of the message sender
                time:
                    type: string
                    example: '2025-01-01T12:00:00Z'
                    description: Timestamp when the message was sent
                reactions:
                    type: object
                    additionalProperties:
                        type: object
                        properties:
                            count:
                                type: integer
                                example: 3
                            users:
                                type: array
                                items:
                                    type: string
                                example: ['Alice', 'Bob']
                    description: >-
                        Reactions to the message (emoji -> reaction data)
            required:
                - id
                - senderId
                - senderUsername

        Reaction:
            type: object
            properties:
                emoji:
                    type: string
                    example: '👍'
                    description: The emoji reaction to toggle (add if not present, remove if already exists)
            required:
                - emoji

        Comment:
            type: object
            properties:
                id:
                    type: string
                    example: 'comment-uuid'
                    description: UUID of the comment
                messageId:
                    type: string
                    example: 'message-uuid'
                    description: UUID of the parent message
                senderId:
                    type: string
                    example: 'user-uuid'
                    description: UUID of the comment sender
                content:
                    type: string
                    example: 'Great point!'
                    description: Content of the comment
            required:
                - id
                - messageId
                - senderId
                - content

        Contact:
            type: object
            properties:
                id:
                    type: string
                    example: 'contact-uuid'
                    description: UUID of the contact
                userId:
                    type: string
                    example: 'user-uuid'
                    description: UUID of the user who owns this contact
                contactUserId:
                    type: string
                    example: 'contact-user-uuid'
                    description: UUID of the user being contacted
                username:
                    type: string
                    example: 'Bob'
                    description: Username of the contact
            required:
                - id
                - userId
                - contactUserId
                - username

        LoginRequest:
            type: object
            properties:
                name:
                    type: string
                    example: 'Alice'
                    pattern: '^.*?$'
                    minLength: 3
                    maxLength: 16
            required:
                - name

        LoginResponse:
            type: object
            properties:
                identifier:
                    type: string
                    example: 'f2555a8a-2e66-4326-9588-20e7e298d615'
                    description: UUID of the logged in user
            required:
                - identifier

        SendMessageRequest:
            type: object
            properties:
                content:
                    type: string
                    example: 'Hello everyone!'
                    description: Content of the message to send
                imageUrl:
                    type: string
                    example: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...'
                    description: Base64 encoded image data with MIME type prefix (optional)
            anyOf:
                - required: [content]
                - required: [imageUrl]

        CreateConversationRequest:
            type: object
            properties:
                participants:
                    type: array
                    items:
                        type: string
                    example: ['user-uuid-1', 'user-uuid-2']
                    description: >-
                        List of user UUIDs to include in the conversation
                name:
                    type: string
                    example: 'Project Discussion'
                    description: >-
                        Name for the conversation (optional for 1:1 chats)
            required:
                - participants

        ForwardMessageRequest:
            type: object
            properties:
                content:
                    type: string
                    example: 'target-conversation-uuid'
                    description: UUID of the target conversation
            required:
                - content

        AddContactRequest:
            type: object
            properties:
                contactUserId:
                    type: string
                    example: 'user-uuid'
                    description: UUID of the user to add as contact
            required:
                - contactUserId

        CommentRequest:
            type: object
            properties:
                content:
                    type: string
                    example: 'Great message!'
                    description: Content of the comment
            required:
                - content

        Error:
            type: object
            properties:
                message:
                    type: string
                    example: 'Invalid input provided'
                    description: Error message describing what went wrong
            required:
                - message

paths:
    /session:
        post:
            tags: ['Authentication']
            summary: User login
            description: |-
                If the user does not exist, it will be created and an
                identifier is returned.
                If the user exists, the user identifier is returned.
            operationId: doLogin
            requestBody:
                description: User login details
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/LoginRequest'
                required: true
            responses:
                '201':
                    description: User login successful
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/LoginResponse'
                '400':
                    description: Invalid input - name must be 3-16 characters
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users:
        get:
            tags: ['Users']
            summary: List all users
            description: Returns a list of all users in the system
            operationId: listUsers
            responses:
                '200':
                    description: List of users
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: '#/components/schemas/User'
                '500':
                    description: Internal server error
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
        put:
            tags: ['Users']
            summary: Update username
            description: Set or update the user's username
            operationId: setMyUserName
            requestBody:
                description: New username as a JSON string
                content:
                    application/json:
                        schema:
                            type: string
                            minLength: 3
                            maxLength: 16
                            example: 'Alice'
                required: true
            responses:
                '200':
                    description: Username updated successfully
                '400':
                    description: Invalid username format
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: User not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/photo:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
        put:
            tags: ['Users']
            summary: Update user photo
            description: Set or update the user's profile picture
            operationId: setMyPhoto
            requestBody:
                description: New photo URL as a JSON string
                content:
                    application/json:
                        schema:
                            type: string
                            example: 'https://example.com/new-avatar.jpg'
                required: true
            responses:
                '200':
                    description: Photo updated successfully
                '400':
                    description: Invalid photo URL
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: User not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/context:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
        get:
            tags: ['Users']
            summary: Get user context
            description: Get context information for the user
            operationId: getContextReply
            responses:
                '200':
                    description: User context retrieved successfully
                    content:
                        application/json:
                            schema:
                                type: object
                '404':
                    description: User not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
        get:
            tags: ['Conversations']
            summary: Get user conversations
            description: Returns all conversations for the specified user
            operationId: getMyConversations
            responses:
                '200':
                    description: List of user conversations
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: '#/components/schemas/Conversation'
                '404':
                    description: User not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
        post:
            tags: ['Conversations']
            summary: Create conversation
            description: >-
                Create a new conversation with specified participants
            operationId: createConversation
            requestBody:
                description: Conversation creation details
                content:
                    application/json:
                        schema:
                            $ref: >-
                                '#/components/schemas/CreateConversationRequest'
                required: true
            responses:
                '201':
                    description: Conversation created successfully
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Conversation'
                '400':
                    description: Invalid request data
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: User not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
        get:
            tags: ['Conversations']
            summary: Get conversation details
            description: Get details of a specific conversation
            operationId: getConversation
            responses:
                '200':
                    description: Conversation details
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Conversation'
                '404':
                    description: Conversation not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/members:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
        post:
            tags: ['Conversations']
            summary: Add member to group
            description: Add a new member to an existing group conversation
            operationId: addtoGroup
            requestBody:
                description: User ID to add to the group
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                userId:
                                    type: string
                                    format: uuid
                            required:
                                - userId
                required: true
            responses:
                '200':
                    description: Member added successfully
                '400':
                    description: Invalid request data
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Conversation or user not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
        delete:
            tags: ['Conversations']
            summary: Leave group
            description: Remove the user from the group conversation
            operationId: leaveGroup
            responses:
                '200':
                    description: Successfully left the group
                '404':
                    description: Conversation not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/name:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
        put:
            tags: ['Conversations']
            summary: Set group name
            description: Set or update the name of a group conversation
            operationId: setGroupName
            requestBody:
                description: New group name
                content:
                    application/json:
                        schema:
                            type: string
                            example: 'Project Team'
                required: true
            responses:
                '200':
                    description: Group name updated successfully
                '400':
                    description: Invalid group name
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Conversation not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/photo:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
        put:
            tags: ['Conversations']
            summary: Set group photo
            description: Set or update the photo of a group conversation
            operationId: setGroupPhoto
            requestBody:
                description: New group photo URL
                content:
                    application/json:
                        schema:
                            type: string
                            example: 'https://example.com/group-photo.jpg'
                required: true
            responses:
                '200':
                    description: Group photo updated successfully
                '400':
                    description: Invalid photo URL
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Conversation not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/messages:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
        get:
            tags: ['Messages']
            summary: Get messages
            description: Get all messages from a conversation
            operationId: getMessages
            responses:
                '200':
                    description: List of messages
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: '#/components/schemas/Message'
                '404':
                    description: Conversation not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
        post:
            tags: ['Messages']
            summary: Send message
            description: Send a new text message or image to the conversation. Images should be provided as base64-encoded data URLs.
            operationId: sendMessage
            requestBody:
                description: Message content (text and/or image)
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/SendMessageRequest'
                required: true
            responses:
                '201':
                    description: Message sent successfully
                    content:
                        application/json:
                            schema:
                                type: string
                                description: UUID of the created message
                '400':
                    description: Invalid message content
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Conversation not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/messages/{messageId}:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
            - name: messageId
              in: path
              description: UUID of the message
              required: true
              schema:
                  type: string
                  format: uuid
        delete:
            tags: ['Messages']
            summary: Delete message
            description: Delete a message (only by the sender)
            operationId: deleteMessage
            responses:
                '200':
                    description: Message deleted successfully
                '403':
                    description: Not authorized to delete this message
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Message not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/messages/{messageId}/forward:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
            - name: messageId
              in: path
              description: UUID of the message
              required: true
              schema:
                  type: string
                  format: uuid
        post:
            tags: ['Messages']
            summary: Forward message
            description: Forward a message (including images) to another conversation with a [Forwarded] prefix
            operationId: forwardMessage
            requestBody:
                description: Target conversation for forwarding
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/ForwardMessageRequest'
                required: true
            responses:
                '200':
                    description: Message forwarded successfully
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Conversation'
                '400':
                    description: Invalid request data
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Message or target conversation not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/messages/{messageId}/reaction:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
            - name: messageId
              in: path
              description: UUID of the message
              required: true
              schema:
                  type: string
                  format: uuid
        post:
            tags: ['Reactions']
            summary: Toggle reaction
            description: Toggle a reaction on a message. If the user has already reacted with this emoji, the reaction will be removed. If not, it will be added.
            operationId: reactToMessage
            requestBody:
                description: Emoji to toggle
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/Reaction'
                required: true
            responses:
                '200':
                    description: Reaction toggled successfully
                '400':
                    description: Invalid reaction data
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Message not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/messages/{messageId}/reaction/{emoji}:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
            - name: messageId
              in: path
              description: UUID of the message
              required: true
              schema:
                  type: string
                  format: uuid
            - name: emoji
              in: path
              description: The emoji reaction to remove
              required: true
              schema:
                  type: string
        delete:
            tags: ['Reactions']
            summary: Remove reaction
            description: Remove a specific reaction from a message
            operationId: removeReaction
            responses:
                '200':
                    description: Reaction removed successfully
                '404':
                    description: Message or reaction not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/messages/{messageId}/comments:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
            - name: messageId
              in: path
              description: UUID of the message
              required: true
              schema:
                  type: string
                  format: uuid
        post:
            tags: ['Comments']
            summary: Add comment
            description: Add a comment to a message
            operationId: commentMessage
            requestBody:
                description: Comment content
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/CommentRequest'
                required: true
            responses:
                '201':
                    description: Comment added successfully
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Comment'
                '400':
                    description: Invalid comment data
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Message not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/conversations/{conversationId}/messages/{messageId}/comments/{commentId}:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: conversationId
              in: path
              description: UUID of the conversation
              required: true
              schema:
                  type: string
                  format: uuid
            - name: messageId
              in: path
              description: UUID of the message
              required: true
              schema:
                  type: string
                  format: uuid
            - name: commentId
              in: path
              description: UUID of the comment
              required: true
              schema:
                  type: string
                  format: uuid
        delete:
            tags: ['Comments']
            summary: Delete comment
            description: Delete a comment (only by the commenter)
            operationId: deleteComment
            responses:
                '200':
                    description: Comment deleted successfully
                '403':
                    description: Not authorized to delete this comment
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: Comment not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/contacts:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
        get:
            tags: ['Contacts']
            summary: List contacts
            description: Get all contacts for the user
            operationId: listContacts
            responses:
                '200':
                    description: List of contacts
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: '#/components/schemas/Contact'
                '404':
                    description: User not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
        post:
            tags: ['Contacts']
            summary: Add contact
            description: Add a new contact for the user
            operationId: addContact
            requestBody:
                description: Contact details
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/AddContactRequest'
                required: true
            responses:
                '201':
                    description: Contact added successfully
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Contact'
                '400':
                    description: Invalid contact data
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'
                '404':
                    description: User not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /users/{id}/contacts/{contactId}:
        parameters:
            - name: id
              in: path
              description: UUID of the user
              required: true
              schema:
                  type: string
                  format: uuid
            - name: contactId
              in: path
              description: UUID of the contact
              required: true
              schema:
                  type: string
                  format: uuid
        delete:
            tags: ['Contacts']
            summary: Remove contact
            description: Remove a contact from the user's contact list
            operationId: removeContact
            responses:
                '200':
                    description: Contact removed successfully
                '404':
                    description: Contact not found
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /conversations/all:
        get:
            tags: ['Conversations']
            summary: Get all conversations
            description: >-
                Returns all conversations in the database (for admin or
                user picker)
            operationId: getAllConversations
            responses:
                '200':
                    description: List of all conversations
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: >-
                                        '#/components/schemas/Conversation'
                '500':
                    description: Internal server error
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /ws:
        get:
            tags: ['WebSocket']
            summary: WebSocket connection
            description: >-
                Establish a WebSocket connection for real-time communication
            operationId: serveWs
            responses:
                '101':
                    description: WebSocket connection established
                '400':
                    description: Bad request - cannot upgrade to WebSocket
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/Error'

    /liveness:
        get:
            tags: ['Health']
            summary: Health check
            description: Health check endpoint for monitoring server status
            operationId: liveness
            responses:
                '200':
                    description: Server is healthy
                    content:
                        text/plain:
                            schema:
                                type: string
                                example: 'OK'
